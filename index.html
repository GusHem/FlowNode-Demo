<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowNode</title>
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg">
    <style>
        /* DESIGN SYSTEM: FlowNode v12.0 */
        :root {
            --font-primary: 'Inter', sans-serif;
            --timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light & Dark Theme Variables */
        body, .flownode-sidebar {
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
            --text-primary: #111827; --text-secondary: #6b7280; --border-color: #e5e7eb;
            --accent-color: #4f46e5; --accent-text: #ffffff; --shadow-color: rgba(0, 0, 0, 0.05);
            --suggestion-bg: #f3f4f6; --suggestion-bg-hover: #e5e7eb;
            --status-red: #ef4444; --status-yellow: #f59e0b; --status-green: #22c55e;
            --status-green-bg: #ecfdf5; --status-green-text: #065f46;
            --status-gray-bg: #f3f4f6; --status-gray-text: #374151;
        }

        .flownode-sidebar.dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --suggestion-bg: #374151; --suggestion-bg-hover: #4b5563;
            --status-green-bg: #064e3b; --status-green-text: #d1fae5;
            --status-gray-bg: #374151; --status-gray-text: #d1d5db;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-primary); color: var(--text-primary);
            font-family: var(--font-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* --- Base Layout --- */
        .split-view-container { display: flex; height: 100vh; width: 100%; }
        
        /* --- DUMMY BROWSER STYLES --- */
        .dummy-browser { flex-grow: 1; display: flex; flex-direction: column; background-color: #eef2ff; position: relative; }
        .browser-header { flex-shrink: 0; background-color: var(--bg-tertiary); }
        .flownode-sidebar.dark .browser-header { background-color: #374151; }
        
        .browser-tabs { display: flex; padding: 0.5rem 0.5rem 0; }
        .browser-tab {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #e0e7ff;
            border: 1px solid #c7d2fe;
            border-bottom: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            position: relative;
            top: 1px;
            cursor: default;
            opacity: 0.7;
        }
        .flownode-sidebar.dark .browser-tab { background-color: #4b5563; border-color: #6b7280; }
        .tab-icon { width: 16px; height: 16px; }

        .browser-tab.active {
            background-color: #fff;
            color: var(--text-primary);
            border-color: var(--border-color);
            border-bottom: 1px solid #fff;
            opacity: 1;
        }
        .flownode-sidebar.dark .browser-tab.active {
            background-color: #fff;
            color: #111827;
            border-color: var(--border-color);
            border-bottom-color: #fff;
        }
        
        .browser-toolbar { display: flex; align-items: center; padding: 0.75rem; background-color: #fff; border-bottom: 1px solid var(--border-color); }
        .window-dots { display: flex; gap: 0.5rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background-color: #ff5f57; } .dot.yellow { background-color: #febc2e; } .dot.green { background-color: #28c840; }
        .address-bar { flex-grow: 1; background-color: var(--bg-tertiary); color: var(--text-secondary); border-radius: 6px; padding: 0.5rem 1rem; margin: 0 1rem; font-size: 0.9rem; text-align: left; border: none; }
        .dummy-content { padding: 2rem; overflow-y: auto; flex-grow: 1; background: #fff;}
        
        /* --- Selection Simulation --- */
        .selection-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(79, 70, 229, 0.1);
            z-index: 1000;
            cursor: crosshair;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            font-weight: 500;
        }
        .selection-overlay::before { /* Instructional text */
            content: 'Klicka och dra f√∂r att v√§lja ett omr√•de';
            background-color: var(--accent-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            animation: fade-in-out-text 2.8s forwards;
        }
        .selection-overlay::after { /* The animated selection box */
            content: '';
            position: absolute;
            top: 45%; left: 30%;
            width: 0; height: 0;
            border: 2px dashed var(--accent-color);
            background-color: rgba(79, 70, 229, 0.2);
            animation: draw-selection-box 1.5s 0.5s forwards ease-in-out;
        }
        @keyframes draw-selection-box { to { width: 40%; height: 20%; } }
        @keyframes fade-in-out-text { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }

        /* --- FlowNode Product Page --- */
        .product-page { max-width: 700px; margin: 2rem auto; text-align: center; color: var(--text-primary); }
        .product-page h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; color: #111827; line-height: 1.2; }
        .product-page .subtitle { font-size: 1.1rem; color: var(--text-secondary); max-width: 500px; margin: 0 auto 2rem; line-height: 1.6; }
        .product-page h3 { font-size: 1.2rem; font-weight: 600; margin-top: 3rem; margin-bottom: 0.5rem; }
        .waitlist-form { display: flex; gap: 0.5rem; margin-top: 1rem; max-width: 450px; margin-left: auto; margin-right: auto; }
        .waitlist-input { flex-grow: 1; background-color: var(--bg-secondary); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; color: var(--text-primary); }
        .waitlist-button { background-color: var(--accent-color); color: var(--accent-text); border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .waitlist-button:hover { opacity: 0.9; }

        .flownode-sidebar {
            width: 420px; min-width: 380px; background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-color); display: flex; flex-direction: column;
            box-shadow: -10px 0 30px var(--shadow-color);
            transition: all 0.3s var(--timing-function);
            position: relative; overflow: hidden;
        }
        
        /* --- View Switching Logic --- */
        .view-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; transition: transform 0.4s var(--timing-function), opacity 0.4s; background-color: var(--bg-secondary); }
        #chat-view { transform: translateX(0); z-index: 2; }
        #canvas-view, #library-view, #team-view, #flows-view, #history-view, #settings-view { transform: translateX(100%); z-index: 1; opacity: 0; }
        .flownode-sidebar.canvas-active #chat-view, .flownode-sidebar.library-active #chat-view, .flownode-sidebar.team-active #chat-view, .flownode-sidebar.flows-active #chat-view, .flownode-sidebar.history-active #chat-view, .flownode-sidebar.settings-active #chat-view { transform: translateX(-100%); opacity: 0; }
        .flownode-sidebar.canvas-active #canvas-view, .flownode-sidebar.library-active #library-view, .flownode-sidebar.team-active #team-view, .flownode-sidebar.flows-active #flows-view, .flownode-sidebar.history-active #history-view, .flownode-sidebar.settings-active #settings-view { transform: translateX(0); opacity: 1; }
        
        /* --- Header --- */
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-secondary); z-index: 5; }
        .sidebar-title { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        .sidebar-avatar { width: 32px; height: 32px; border-radius: 8px; }
        .sidebar-title-text { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .version-badge { font-size: 0.6rem; font-weight: bold; color: var(--accent-color); background-color: var(--bg-tertiary); padding: 2px 5px; border-radius: 4px; margin-left: auto; flex-shrink: 0;}
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .collaborators { display: flex; align-items: center; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--bg-secondary); margin-left: -10px; background-size: cover; box-shadow: 0 0 0 1px var(--border-color); }
        .header-btn { background: none; border: none; color: var(--text-secondary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .header-btn:hover { color: var(--text-primary); background-color: var(--bg-tertiary); }
        .header-btn svg { width: 20px; height: 20px; }
        
        /* --- Chat UI --- */
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .welcome-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); padding: 2rem; }
        .welcome-placeholder svg { width: 48px; height: 48px; color: var(--accent-color); opacity: 0.5; margin-bottom: 1rem; }
        .welcome-placeholder h3 { font-size: 1.1rem; color: var(--text-primary); margin-bottom: 0.25rem; }
        .chat-message { max-width: 95%; font-size: 0.9rem; line-height: 1.5; opacity: 0; transform: translateY(10px); animation: fade-in 0.5s var(--timing-function) forwards; }
        @keyframes fade-in { to { opacity: 1; transform: translateY(0); } }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 12px; }
        .user-message { align-self: flex-end; } .user-message .message-bubble { background-color: var(--accent-color); color: var(--accent-text); }
        .bot-message { align-self: flex-start; display: flex; align-items: flex-end; gap: 0.75rem; } .bot-message .message-bubble { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .chat-input-area { flex-shrink: 0; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background-color: var(--bg-secondary); }
        .chat-input-bar { display: flex; align-items: flex-end; background-color: var(--bg-tertiary); border-radius: 12px; padding: 0.25rem; gap: 0.25rem; }
        #chat-input { flex-grow: 1; border: none; background: none; outline: none; resize: none; padding: 0.6rem 0.75rem; font-size: 0.9rem; color: var(--text-primary); font-family: var(--font-primary); max-height: 120px; overflow-y: auto; }
        .chat-action-btn { width: 36px; height: 36px; border-radius: 8px; flex-shrink: 0; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chat-action-btn.primary { background-color: var(--accent-color); color: var(--accent-text); }
        .chat-action-btn.secondary { background-color: transparent; color: var(--text-secondary); }
        .chat-action-btn.secondary:hover { background-color: var(--suggestion-bg-hover); color: var(--text-primary); }
        .chat-action-btn svg { width: 18px; height: 18px; }
        .suggestion-card-container { padding: 0 0 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .suggestion-btn { background-color: var(--suggestion-bg); color: var(--text-primary); border: none; width: 100%; text-align: left; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s var(--timing-function); display: flex; align-items: center; gap: 0.75rem; }
        .suggestion-btn:hover { background-color: var(--suggestion-bg-hover); }

        /* --- Tool Library --- */
        .library-content { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .library-search { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        #tool-search-input { width: 100%; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.9rem; color: var(--text-primary); }
        .tool-library-container { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .tool-category h3 { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .tool-card { text-align: center; padding: 1.5rem 1rem; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); transition: all 0.2s; cursor: pointer; }
        .tool-card:hover { transform: translateY(-4px); box-shadow: 0 4px 15px var(--shadow-color); }
        .tool-card .tool-icon { width: 48px; height: 48px; border-radius: 12px; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white; }
        .tool-card .tool-name { font-weight: 500; color: var(--text-primary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 0.5rem; }
        .status-dot.connected { background-color: var(--status-green); }
        
        /* --- Team View --- */
        .team-view-container { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .team-member-list { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
        .team-member-card { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg-tertiary); padding: 1rem; border-radius: 12px; }
        .member-info { display: flex; align-items: center; gap: 1rem; }
        .member-avatar { width: 48px; height: 48px; border-radius: 50%; background-size: cover; position: relative; }
        .online-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: var(--status-gray-text); border: 2px solid var(--bg-tertiary); position: absolute; bottom: 0; right: 0; }
        .online-indicator.online { background-color: var(--status-green); }
        .member-details .name { font-weight: 600; color: var(--text-primary); }
        .member-details .role { font-size: 0.8rem; color: var(--text-secondary); }
        .member-socials { display: flex; gap: 0.5rem; }
        .member-socials a { color: var(--text-secondary); text-decoration: none; }
        .member-socials a:hover { color: var(--accent-color); }
        .member-socials svg { width: 20px; height: 20px; }
        .invite-section h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .invite-bar { display: flex; gap: 0.5rem; }
        .invite-input { flex-grow: 1; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.6rem; color: var(--text-primary); font-size: 0.9rem; }
        .invite-btn { border: none; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; background-color: var(--accent-color); color: var(--accent-text); }
        
        /* --- Flows View --- */
        .flows-view-container { flex-grow: 1; display: flex; flex-direction: column; }
        .flows-list { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .flow-card { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid var(--border-color); background-color: var(--bg-secondary); cursor: pointer; transition: border-color 0.2s; }
        .flow-card:hover { border-color: var(--accent-color); }
        .flow-card.active { border-color: var(--accent-color); }
        .flows-footer { padding: 1rem; border-top: 1px solid var(--border-color); }
        .create-flow-btn { width: 100%; border: none; padding: 0.7rem; border-radius: 8px; font-weight: 500; cursor: pointer; background-color: var(--accent-color); color: var(--accent-text); }
        
        /* --- Canvas View --- */
        .workflow-canvas-container { flex-grow: 1; position: relative; overflow: hidden; background-color: var(--bg-primary); background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 16px 16px; }
        .flownode-sidebar.dark .workflow-canvas-container { background-image: radial-gradient(#374151 1px, transparent 1px); }
        .workflow-node {
            position: absolute;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 10px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 220px;
            cursor: grab;
            opacity: 0;
            transform: scale(0.9);
            animation: node-fade-in 0.3s var(--timing-function) forwards;
        }
        @keyframes node-fade-in { to { opacity: 1; transform: scale(1); } }
        .node-icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .node-label { font-size: 0.9rem; font-weight: 500; color: var(--text-primary); }
        .connection-line { stroke: var(--text-secondary); stroke-width: 2; fill: none; }
        
        /* --- History & Settings Views --- */
        .history-view-container, .settings-view-container { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .view-title { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1.5rem; }
        .history-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); cursor: pointer; transition: border-color 0.2s; }
        .history-item:hover { border-color: var(--accent-color); }
        .history-title { font-size: 0.9rem; font-weight: 500; }
        .history-date { font-size: 0.8rem; color: var(--text-secondary); }
        .setting-item { margin-bottom: 2rem; }
        .setting-item label { display: block; font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .setting-description { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5; }
        .settings-input { width: 100%; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.9rem; color: var(--text-primary); }
    </style>
</head>
<body>
    <!-- SVG Icons -->
    <svg width="0" height="0" style="display:none;">
        <symbol id="icon-flow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/><path d="M15.5 16l-4-4 4-4"/><path d="M8.5 16l4-4-4-4"/></symbol>
        <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></symbol>
        <symbol id="icon-chat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></symbol>
        <symbol id="icon-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></symbol>
        <symbol id="icon-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></symbol>
        <symbol id="icon-history" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v15H6.5A2.5 2.5 0 0 1 4 14.5v-10A2.5 2.5 0 0 1 6.5 2z"></path></symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></symbol>
        <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L9.27 9.27L3 12l6.27 2.73L12 21l2.73-6.27L21 12l-6.27-2.73z"/></symbol>
        <symbol id="icon-select-area" viewBox="0 0 24 24" fill="currentColor"><path d="M17 15h2V7c0-1.1-.9-2-2-2h-8v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/></symbol>
        <symbol id="icon-linkedin" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></symbol>
        <symbol id="icon-twitter" viewBox="0 0 24 24" fill="currentColor"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616v.064c0 2.298 1.634 4.212 3.793 4.649-.65.177-1.354.23-2.067.087.616 1.9 2.396 3.281 4.5 3.315-2.056 1.623-4.596 2.45-7.221 2.054 2.146 1.373 4.69 2.16 7.34 2.16 8.517 0 13.18-7.058 13.18-13.18 0-.201 0-.402-.013-.602.9-.648 1.68-1.46 2.304-2.393z"/></symbol>
    </svg>

    <div class="split-view-container">
        <!-- Dummy Browser View -->
        <div class="dummy-browser">
            <div class="browser-header">
                <div class="browser-tabs">
                    <div class="browser-tab active">
                        <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg" class="tab-icon" alt="Nordsym logo">
                        FlowNode - Automate Everything
                    </div>
                    <div class="browser-tab">
                        <img src="https://i.imgur.com/72011vj.png" class="tab-icon" alt="Salesforce icon">
                        Salesforce Opportunity
                    </div>
                </div>
                <div class="browser-toolbar">
                    <div class="window-dots"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
                    <input type="text" class="address-bar" value="https://www.flownode.ai">
                </div>
            </div>
            <div class="dummy-content">
                <div class="product-page">
                    <h1>Automatisering, direkt i din webbl√§sare.</h1>
                    <p class="subtitle">FlowNode √§r ett Chrome-till√§gg som l√•ter dig koppla samman dina favoritappar som Salesforce, Jira och Slack utan en enda rad kod. S√§g hejd√• till kr√•ngliga API-nycklar och hej till s√∂ml√∂sa arbetsfl√∂den.</p>
                    
                    <h3>G√• med p√• v√•r v√§ntelista</h3>
                    <form class="waitlist-form" onsubmit="event.preventDefault(); this.innerHTML = '<p style=\'color: var(--status-green-text); font-weight: 500;\'>Tack! Du √§r nu p√• v√§ntelistan.</p>';">
                        <input type="email" placeholder="din.mejl@foretag.se" class="waitlist-input" required>
                        <button type="submit" class="waitlist-button">Skriv upp mig</button>
                    </form>
                </div>
                <pre id="page-content" style="display:none;">FlowNode Landing Page. H1: Automatisering, direkt i din webbl√§sare. Subtitle: FlowNode √§r ett Chrome-till√§gg som l√•ter dig koppla samman dina favoritappar utan kod.</pre>
            </div>
            <div id="selection-simulation-overlay" class="selection-overlay" style="display: none;"></div>
        </div>

        <!-- FlowNode Sidebar -->
        <div class="flownode-sidebar" id="flownode-sidebar">
            <!-- VIEW 1: CHAT -->
            <div id="chat-view" class="view-container">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Gra%CC%88vling%20flownode%20avatar.svg" alt="FlowNode Avatar" class="sidebar-avatar">
                        <h2 class="sidebar-title-text">FlowNode</h2>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="show-flows-btn" title="Mina Fl√∂den"><svg><use href="#icon-folder"></use></svg></button>
                        <button class="header-btn" id="show-library-btn" title="Verktygsbibliotek"><svg><use href="#icon-grid"></use></svg></button>
                        <button class="header-btn" id="show-team-btn" title="Team & Socials"><svg><use href="#icon-users"></use></svg></button>
                        <button class="header-btn" id="show-history-btn" title="Chatthistorik"><svg><use href="#icon-history"></use></svg></button>
                        <button class="header-btn" id="show-settings-btn" title="Inst√§llningar"><svg><use href="#icon-settings"></use></svg></button>
                        <button class="header-btn" id="theme-toggle-btn" title="V√§xla tema"><svg id="theme-icon"><use href="#icon-sun"></use></svg></button>
                    </div>
                </div>
                 <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area" id="chat-input-area">
                        <div id="contextual-suggestions"></div>
                        <div class="chat-input-bar">
                            <button class="chat-action-btn secondary" id="select-area-btn" title="V√§lj ett omr√•de att analysera"><svg><use href="#icon-select-area"></use></svg></button>
                            <button class="chat-action-btn secondary" id="analyze-page-btn" title="Analysera Hela Sidan"><svg><use href="#icon-sparkles"></use></svg></button>
                            <textarea id="chat-input" placeholder="Skriv ett meddelande..." rows="1"></textarea>
                            <button id="chat-send-btn" class="chat-action-btn primary" title="Skicka">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other Views -->
            <div id="canvas-view" class="view-container">
                 <div class="sidebar-header">
                    <div class="sidebar-title">
                        <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Gra%CC%88vling%20flownode%20avatar.svg" alt="FlowNode Avatar" class="sidebar-avatar">
                        <h2 class="sidebar-title-text" id="active-flow-title-canvas"></h2>
                    </div>
                    <div class="header-actions"><button class="header-btn" id="show-chat-btn-canvas" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 </div>
                 <div class="workflow-canvas-container">
                    <svg id="workflow-svg-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></svg>
                    <div id="workflow-canvas" style="position:relative; width: 100%; height: 100%;"></div>
                </div>
            </div>
            <div id="library-view" class="view-container">
                 <div class="sidebar-header">
                    <div class="sidebar-title"><h2>Verktygsbibliotek</h2></div>
                    <div class="header-actions"><button class="header-btn" id="show-chat-btn-library" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 </div>
                 <div class="library-content">
                    <div class="library-search"><input type="text" id="tool-search-input" placeholder="S√∂k verktyg..."></div>
                    <div class="tool-library-container" id="tool-library-container"></div>
                 </div>
            </div>
            <div id="team-view" class="view-container">
                 <div class="sidebar-header">
                    <div class="sidebar-title"><h2>Team & Socials</h2></div>
                    <div class="header-actions"><button class="header-btn" id="show-chat-btn-team" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 </div>
                 <div class="team-view-container" id="team-view-container"></div>
            </div>
            <div id="flows-view" class="view-container">
                 <div class="sidebar-header">
                    <div class="sidebar-title"><h2>Mina Fl√∂den</h2></div>
                    <div class="header-actions"><button class="header-btn" id="show-chat-btn-flows" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 </div>
                 <div class="flows-view-container">
                    <div class="flows-list" id="flows-list"></div>
                    <div class="flows-footer"><button class="create-flow-btn" id="create-flow-btn">Skapa nytt fl√∂de</button></div>
                 </div>
            </div>
            <div id="history-view" class="view-container">
                 <div class="header-actions" style="position: absolute; top: 0.75rem; right: 1rem; z-index: 10;"><button class="header-btn" id="show-chat-btn-history" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 <div class="history-view-container" id="history-view-container"></div>
            </div>
            <div id="settings-view" class="view-container">
                 <div class="header-actions" style="position: absolute; top: 0.75rem; right: 1rem; z-index: 10;"><button class="header-btn" id="show-chat-btn-settings" title="Visa chatt"><svg><use href="#icon-chat"></use></svg></button></div>
                 <div class="settings-view-container" id="settings-view-container"></div>
            </div>
        </div>
    </div>

    <script>
    'use strict';
    
    // --- CORE APP STRUCTURE (Placeholders) ---
    // These objects are defined upfront to establish the application's structure.
    // They are populated with data and methods later in the script.
    
    const GeminiService = {}; // Handles AI interactions.
    const NodeLibrary = {};   // Defines different workflow node types.
    const State = {};         // Manages all application data.
    const App = {};           // Contains the main application logic and UI orchestration.

    // --- MAIN APP LOGIC ---
    Object.assign(App, {
        // Initializes the application.
        async init() {
            this.elements = {
                sidebar: document.getElementById('flownode-sidebar'),
                chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'),
                chatSendBtn: document.getElementById('chat-send-btn'), analyzePageBtn: document.getElementById('analyze-page-btn'),
                contextualSuggestions: document.getElementById('contextual-suggestions'),
                activeFlowTitleCanvas: document.getElementById('active-flow-title-canvas'), themeToggleBtn: document.getElementById('theme-toggle-btn'),
                showLibraryBtn: document.getElementById('show-library-btn'), showFlowsBtn: document.getElementById('show-flows-btn'),
                showTeamBtn: document.getElementById('show-team-btn'), pageContent: document.getElementById('page-content'),
                themeIcon: document.getElementById('theme-icon'), showChatBtnCanvas: document.getElementById('show-chat-btn-canvas'),
                showChatBtnLibrary: document.getElementById('show-chat-btn-library'), showChatBtnTeam: document.getElementById('show-chat-btn-team'),
                showChatBtnFlows: document.getElementById('show-chat-btn-flows'), createFlowBtn: document.getElementById('create-flow-btn'),
                flowsList: document.getElementById('flows-list'), toolLibraryContainer: document.getElementById('tool-library-container'),
                toolSearchInput: document.getElementById('tool-search-input'), teamViewContainer: document.getElementById('team-view-container'),
                selectAreaBtn: document.getElementById('select-area-btn'),
                selectionOverlay: document.getElementById('selection-simulation-overlay'),
                workflowCanvas: document.getElementById('workflow-canvas'),
                workflowSvgLayer: document.getElementById('workflow-svg-layer'),
                // New elements
                showHistoryBtn: document.getElementById('show-history-btn'),
                showSettingsBtn: document.getElementById('show-settings-btn'),
                historyViewContainer: document.getElementById('history-view-container'),
                settingsViewContainer: document.getElementById('settings-view-container'),
                showChatBtnHistory: document.getElementById('show-chat-btn-history'),
                showChatBtnSettings: document.getElementById('show-chat-btn-settings'),
            };
            
            await State.load();
            this.applyTheme();
            this.setupListeners();
            this.renderAll();
            this.renderWelcomeMessage();
        },

        // Sets up all event listeners.
        setupListeners() {
            Object.values(this.elements).forEach(el => { if(!el) console.error("Ett UI-element saknas!"); });
            this.elements.chatSendBtn.onclick = () => this.handleUserMessage();
            this.elements.analyzePageBtn.onclick = () => this.fetchAndShowSuggestions();
            this.elements.chatInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleUserMessage(); }};
            this.elements.showLibraryBtn.onclick = () => this.setView('library');
            this.elements.showTeamBtn.onclick = () => this.setView('team');
            this.elements.showFlowsBtn.onclick = () => this.setView('flows');
            this.elements.showHistoryBtn.onclick = () => this.setView('history');
            this.elements.showSettingsBtn.onclick = () => this.setView('settings');
            this.elements.themeToggleBtn.onclick = () => this.toggleTheme();
            this.elements.toolSearchInput.onkeyup = () => this.renderToolLibrary();
            this.elements.createFlowBtn.onclick = () => this.createNewFlow();
            document.querySelectorAll('#show-chat-btn-canvas, #show-chat-btn-library, #show-chat-btn-team, #show-chat-btn-flows, #show-chat-btn-history, #show-chat-btn-settings').forEach(btn => {
                if(btn) btn.onclick = () => this.setView('chat');
            });
            this.elements.selectAreaBtn.onclick = () => this.simulateAreaSelection();
        },
        
        // Simulates the user selecting an area on the page.
        simulateAreaSelection() {
            this.elements.chatMessages.querySelector(".welcome-placeholder")?.remove();
            const overlay = this.elements.selectionOverlay;
            if (!overlay) return;
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.display = 'none';
                this.addMessage({ 
                    sender: 'bot', 
                    content: { type: 'text', value: 'Omr√•de valt! Nu kan du st√§lla specifika fr√•gor om det.' } 
                });
            }, 2800);
        },
        
        // A master render function to update all dynamic UI parts.
        renderAll() {
            this.renderActiveFlowHeader(); 
            this.renderFlowsList(); 
            this.renderToolLibrary(); 
            this.renderTeamView();
            this.renderWorkflowCanvas();
            this.renderHistoryView();
            this.renderSettingsView();
        },

        // Displays the initial message in the chat window.
        renderWelcomeMessage() {
            this.elements.chatMessages.innerHTML = `
                <div class="welcome-placeholder">
                    <svg><use href="#icon-flow"></use></svg>
                    <h3>V√§lkommen till FlowNode</h3>
                    <p>Klicka p√• ‚ú® f√∂r att analysera sidan, eller st√§ll en fr√•ga.</p>
                </div>`;
        },
        
        // Renders the visual representation of the current workflow.
        renderWorkflowCanvas() {
            const flow = this.getActiveFlow();
            const canvas = this.elements.workflowCanvas;
            const svgLayer = this.elements.workflowSvgLayer;
            if (!flow || !canvas || !svgLayer) return;

            canvas.innerHTML = '';
            svgLayer.innerHTML = '';

            if (flow.nodes.length === 0) {
                canvas.innerHTML = `<div style="position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); color: var(--text-secondary); text-align: center;">B√∂rja med att bygga ett fl√∂de i chatten.</div>`;
                return;
            }

            flow.nodes.forEach(node => {
                const nodeInfo = NodeLibrary[node.variantId] || NodeLibrary.default;
                const nodeEl = document.createElement('div');
                nodeEl.className = 'workflow-node';
                nodeEl.id = `flow-node-${node.id}`;
                nodeEl.style.left = `${node.position.x}px`;
                nodeEl.style.top = `${node.position.y}px`;
                nodeEl.innerHTML = `
                    <div class="node-icon" style="background-color: ${nodeInfo.color};">${nodeInfo.icon}</div>
                    <div class="node-label">${nodeInfo.label}</div>
                `;
                canvas.appendChild(nodeEl);
            });
            
            // Defer connection drawing to ensure nodes are in the DOM and have positions.
            setTimeout(() => {
                 flow.connections.forEach(conn => {
                    const fromNode = document.getElementById(`flow-node-${conn.from}`);
                    const toNode = document.getElementById(`flow-node-${conn.to}`);
                    if (fromNode && toNode) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        const x1 = fromNode.offsetLeft + fromNode.offsetWidth;
                        const y1 = fromNode.offsetTop + fromNode.offsetHeight / 2;
                        const x2 = toNode.offsetLeft;
                        const y2 = toNode.offsetTop + toNode.offsetHeight / 2;
                        line.setAttribute('x1', x1);
                        line.setAttribute('y1', y1);
                        line.setAttribute('x2', x2);
                        line.setAttribute('y2', y2);
                        line.setAttribute('class', 'connection-line');
                        svgLayer.appendChild(line);
                    }
                });
            }, 10);
        },

        // Changes the visible panel in the sidebar.
        setView(view) { 
            this.elements.sidebar.className = "flownode-sidebar";
            if (State.theme === 'dark') this.elements.sidebar.classList.add('dark');
            if (view !== 'chat') this.elements.sidebar.classList.add(`${view}-active`);
            if (view === 'flows') this.renderFlowsList();
            if (view === 'canvas') this.renderWorkflowCanvas();
        },

        getActiveFlow() { return State.flows.find(f => f.id === State.activeFlowId) || State.flows[0]; },
        renderActiveFlowHeader() { const flow = this.getActiveFlow(); if(flow) { this.elements.activeFlowTitleCanvas.textContent = flow.name; } },
        applyTheme() { this.elements.sidebar.classList.toggle('dark', State.theme === 'dark'); this.elements.themeIcon.innerHTML = `<use href="${State.theme === 'dark' ? '#icon-moon' : '#icon-sun'}"></use>`; this.renderWorkflowCanvas(); },
        toggleTheme() { State.theme = State.theme === 'light' ? 'dark' : 'light'; this.applyTheme(); },
        setActiveFlow(flowId) { State.activeFlowId = flowId; this.renderAll(); this.setView('chat'); },
    });
    
    // --- NODE LIBRARY DEFINITIONS ---
    Object.assign(NodeLibrary, {
        'salesforce-deal-won': { label: 'Salesforce: Aff√§r Vunnen', icon: '‚òÅÔ∏è', color: '#00A1E0' },
        'slack-send-message': { label: 'Slack: Skicka Meddelande', icon: 'üí¨', color: '#4A154B' },
        'default': { label: 'Ok√§nd Nod', icon: '?', color: '#6b7280' }
    });

    // --- MOCK SERVICES ---
    // This section simulates API calls to a backend or AI service.
    Object.assign(GeminiService, {
        // Interprets the user's initial query to decide if it's a chat or a command.
        interpretQuery: async (query) => {
            await new Promise(r => setTimeout(r, 200)); // Simulate network delay
            const buildKeywords = ["skapa fl√∂de", "automatisera", "regel:", "n√§r "];
            const isBuildCommand = buildKeywords.some(k => query.toLowerCase().startsWith(k));
            return isBuildCommand ? { intent: "BUILD_WORKFLOW", command: query } : { intent: "CHAT", query: query };
        },

        // Simulates building a workflow from a command.
        buildWorkflow: async (command) => {
            await new Promise(r => setTimeout(r, 1000));
            const lowerCmd = command.toLowerCase();
            if (lowerCmd.includes("salesforce") && lowerCmd.includes("slack")) {
                return {
                    success: true,
                    workflow: {
                        nodes: [
                            { id: "n1", variantId: "salesforce-deal-won", position: { x: 40, y: 100 } },
                            { id: "n2", variantId: "slack-send-message", position: { x: 300, y: 140 } }
                        ],
                        connections: [{ from: "n1", to: "n2" }]
                    }
                };
            }
            return { success: false, reason: "F√∂rstod ej fl√∂det." };
        },
        
        // Simulates a chat response based on page context.
        chatAboutContext: async (query, context) => {
            await new Promise(r => setTimeout(r, 800));
            const lowerQuery = query.toLowerCase();
            const lowerContext = context.toLowerCase();
            if (lowerQuery.includes("v√§rde")) {
                const valueMatch = lowerContext.match(/\$(\d{1,3}(,\d{3})*(\.\d+)?)/);
                return { success: true, answer: valueMatch ? `V√§rdet √§r ${valueMatch[0]}.` : "Hittade ej v√§rde." };
            }
            if (lowerQuery.includes("ansvarig")) {
                return { success: true, answer: "Ansvarig √§r Anna Berg." };
            }
            return { success: true, answer: "Det var en intressant fr√•ga!" };
        },

        // Simulates getting suggestions based on page content.
        suggestFromContext: async (context) => {
            await new Promise(r => setTimeout(r, 1000));
            if (context.toLowerCase().includes("flownode landing page")) {
                return {
                    success: true,
                    title: "F√∂rslag f√∂r sidan:",
                    suggestions: [{
                        label: "Skapa ett v√§lkomstfl√∂de f√∂r nya anv√§ndare",
                        command: "Skapa fl√∂de: N√§r en ny anv√§ndare skriver upp sig, skicka ett v√§lkomstmejl och l√§gg till i CRM."
                    }]
                };
            }
            return { success: false };
        }
    });

    // --- STATE MANAGEMENT ---
    Object.assign(State, {
        users: [
            { id: "u1", name: "You", avatar: "https://i.pravatar.cc/40?u=user1", role: "Admin", online: true, socials: { linkedin: "#", twitter: "#" } },
            { id: "u2", name: "Anna Berg", avatar: "https://i.pravatar.cc/40?u=user2", role: "Sales Lead", online: true, socials: { linkedin: "#", twitter: "#" } },
            { id: "u3", name: "Karl Nilsson", avatar: "https://i.pravatar.cc/40?u=user3", role: "Developer", online: false, socials: { linkedin: "#", twitter: "#" } },
            { id: "u4", name: "Sofia Lund", avatar: "https://i.pravatar.cc/40?u=user4", role: "Marketing", online: true, socials: { linkedin: "#", twitter: "#" } }
        ],
        theme: "light",
        activeFlowId: "flow1",
        flows: [{ id: "flow1", name: "Nytt S√§ljfl√∂de", nodes: [], connections: [] }],
        chatHistory: [
            { id: "hist1", title: "Analys av landningssida", date: "2024-09-24" },
            { id: "hist2", title: "Skapa Salesforce-fl√∂de", date: "2024-09-23" },
            { id: "hist3", title: "Fr√•gor om Jira-integration", date: "2024-09-22" },
        ],
        settings: {
            agentPersona: "En hj√§lpsam och koncis expert p√• automatisering."
        },
        tools: {
            "Project Management": [{id:"jira",name:"Jira",iconBg:"#0052CC",connected:true},{id:"asana",name:"Asana",iconBg:"#273347",connected:false},{id:"trello",name:"Trello",iconBg:"#0079BF",connected:true},{id:"notion",name:"Notion",iconBg:"#000000",connected:false},{id:"monday",name:"Monday.com",iconBg:"#FF1A5A",connected:false}],
            "Development": [{id:"github",name:"GitHub",iconBg:"#181717",connected:true},{id:"gitlab",name:"GitLab",iconBg:"#FC6D26",connected:false},{id:"bitbucket",name:"Bitbucket",iconBg:"#0052CC",connected:false},{id:"datadog",name:"Datadog",iconBg:"#632CA6",connected:true}],
            "Sales & CRM": [{id:"salesforce",name:"Salesforce",iconBg:"#00A1E0",connected:true},{id:"hubspot",name:"HubSpot",iconBg:"#FF7A59",connected:false},{id:"pipedrive",name:"Pipedrive",iconBg:"#2D883D",connected:false}],
            "Communication": [{id:"slack",name:"Slack",iconBg:"#4A154B",connected:false},{id:"discord",name:"Discord",iconBg:"#5865F2",connected:true},{id:"msteams",name:"MS Teams",iconBg:"#6264A7",connected:false}],
            "Documents & Files": [{id:"gsheets",name:"Google Sheets",iconBg:"#188038",connected:true},{id:"gdrive",name:"Google Drive",iconBg:"#4285F4",connected:false},{id:"dropbox",name:"Dropbox",iconBg:"#0061FF",connected:false}]
        },
        load: async () => { /* Placeholder for loading state */ },
        save: async () => { /* Placeholder for saving state */ }
    });

    // --- APP METHOD IMPLEMENTATIONS ---
    Object.assign(App, {
        handleUserMessage: async function() {
            const userInput = this.elements.chatInput.value.trim();
            if (!userInput) return;

            this.elements.chatMessages.querySelector(".welcome-placeholder")?.remove();
            this.addMessage({ sender: "user", content: { type: "text", value: userInput } });
            this.elements.chatInput.value = "";
            this.elements.contextualSuggestions.innerHTML = "";

            const loadingMsg = this.addMessage({ sender: "bot", content: { type: "loading" } });
            const interpretation = await GeminiService.interpretQuery(userInput);

            if (interpretation.intent === "BUILD_WORKFLOW") {
                const result = await GeminiService.buildWorkflow(interpretation.command);
                this.removeMessage(loadingMsg.id);
                if (result.success) {
                    const activeFlow = this.getActiveFlow();
                    if (activeFlow) {
                        activeFlow.nodes = result.workflow.nodes;
                        activeFlow.connections = result.workflow.connections;
                        await State.save();
                        this.addMessage({ sender: "bot", content: { type: "text", value: "OK, jag har skapat fl√∂det. Kika i canvas-vyn!" } });
                        this.renderAll();
                        setTimeout(() => this.setView("canvas"), 500);
                    }
                } else {
                    this.addMessage({ sender: "bot", content: { type: "text", value: result.reason } });
                }
            } else { // CHAT intent
                const pageContext = this.elements.pageContent.textContent;
                const result = await GeminiService.chatAboutContext(interpretation.query, pageContext);
                this.removeMessage(loadingMsg.id);
                if (result.success) {
                    this.addMessage({ sender: "bot", content: { type: "text", value: result.answer } });
                }
            }
        },

        fetchAndShowSuggestions: async function() {
            this.elements.chatMessages.querySelector(".welcome-placeholder")?.remove();
            const loadingMsg = this.addMessage({ sender: "bot", content: { type: "loading" } });
            const pageContext = this.elements.pageContent.textContent;
            const result = await GeminiService.suggestFromContext(pageContext);
            this.removeMessage(loadingMsg.id);
            if (result.success) {
                this.renderSuggestions(result.title, result.suggestions);
            } else {
                this.addMessage({ sender: "bot", content: { type: "text", value: "Hittade inga f√∂rslag f√∂r den h√§r sidan." } });
            }
        },

        renderSuggestions: function(title, suggestions) {
            let html = `<div class="suggestion-card-container">
                <p style="font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem;">${title}</p>`;
            suggestions.forEach(sugg => {
                html += `<button class="suggestion-btn" data-command="${sugg.command}">${sugg.label}</button>`;
            });
            html += `</div>`;
            this.elements.contextualSuggestions.innerHTML = html;
            this.elements.contextualSuggestions.querySelectorAll(".suggestion-btn").forEach(btn => {
                btn.onclick = () => {
                    this.elements.chatInput.value = btn.dataset.command;
                    this.handleUserMessage();
                };
            });
        },

        addMessage: function(msg) {
            const msgId = `msg-${Date.now()}`;
            const msgEl = document.createElement("div");
            const senderClass = msg.sender === "user" ? "user-message" : "bot-message";
            msgEl.className = `chat-message ${senderClass}`;
            msgEl.id = msgId;
            const content = msg.content.type === "loading" ? "..." : msg.content.value;
            
            if (msg.sender === 'bot') {
                 msgEl.innerHTML = `
                    <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/FlowNode%20gra%CC%88vling%20avatar%20closeup.svg" alt="Agent Avatar" class="message-avatar">
                    <div class="message-bubble">${content}</div>
                `;
            } else {
                 msgEl.innerHTML = `<div class="message-bubble">${content}</div>`;
            }

            this.elements.chatMessages.appendChild(msgEl);
            this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            return { id: msgId, element: msgEl };
        },

        removeMessage: function(msgId) {
            document.getElementById(msgId)?.remove();
        },

        createNewFlow: function() {
            const newFlow = { id: `flow_${Date.now()}`, name: "Namnl√∂st fl√∂de", nodes: [], connections: [] };
            State.flows.push(newFlow);
            State.activeFlowId = newFlow.id;
            this.renderAll();
            this.setView("chat");
        },

        renderFlowsList: function() {
            const container = this.elements.flowsList;
            if (container) {
                container.innerHTML = State.flows.map(flow =>
                    `<div class="flow-card ${flow.id === State.activeFlowId ? "active" : ""}" data-flow-id="${flow.id}">
                        <span>${flow.name}</span>
                    </div>`
                ).join("");
                container.querySelectorAll(".flow-card").forEach(card => {
                    card.onclick = () => this.setActiveFlow(card.dataset.flowId);
                });
            }
        },

        renderToolLibrary: function() {
            const container = this.elements.toolLibraryContainer;
            const searchTerm = this.elements.toolSearchInput.value.toLowerCase();
            let html = "";
            for (const category in State.tools) {
                const filteredTools = State.tools[category].filter(tool => tool.name.toLowerCase().includes(searchTerm));
                if (filteredTools.length > 0) {
                    html += `<div class="tool-category"><h3>${category}</h3><div class="tool-grid">`;
                    filteredTools.forEach(tool => {
                        html += `
                        <div class="tool-card" data-tool-id="${tool.id}">
                            <div class="tool-icon" style="background-color: ${tool.iconBg};">${tool.name.charAt(0)}</div>
                            <div class="tool-name">${tool.name} <span class="status-dot ${tool.connected ? "connected" : ""}"></span></div>
                        </div>`;
                    });
                    html += `</div></div>`;
                }
            }
            container.innerHTML = html;
        },

        renderTeamView: function() {
            const container = this.elements.teamViewContainer;
            if (container) {
                container.innerHTML = `
                <div class="team-member-list">
                    ${State.users.map(user => `
                    <div class="team-member-card">
                        <div class="member-info">
                            <div class="member-avatar" style="background-image: url(${user.avatar})">
                                <div class="online-indicator ${user.online ? "online" : ""}"></div>
                            </div>
                            <div class="member-details">
                                <div class="name">${user.name} ${user.id === "u1" ? "(You)" : ""}</div>
                                <div class="role">${user.role}</div>
                            </div>
                        </div>
                        <div class="member-socials">
                            <a href="${user.socials.linkedin}" target="_blank" title="LinkedIn"><svg><use href="#icon-linkedin"></use></svg></a>
                            <a href="${user.socials.twitter}" target="_blank" title="Twitter"><svg><use href="#icon-twitter"></use></svg></a>
                        </div>
                    </div>`).join("")}
                </div>
                <div class="invite-section">
                    <h3>Bjud in teammedlem</h3>
                    <div class="invite-bar">
                        <input type="email" class="invite-input" id="invite-email-input" placeholder="kollega@foretag.se">
                        <button class="invite-btn" id="invite-btn">Bjud in</button>
                    </div>
                </div>`;
            }
        },

        renderHistoryView: function() {
            const container = this.elements.historyViewContainer;
            if (container) {
                container.innerHTML = `<h2 class="view-title">Chatthistorik</h2><div class="history-list">` +
                    State.chatHistory.map(chat => `
                        <div class="history-item" data-id="${chat.id}">
                            <span class="history-title">${chat.title}</span>
                            <span class="history-date">${chat.date}</span>
                        </div>
                    `).join("") + `</div>`;
            }
        },

        renderSettingsView: function() {
            const container = this.elements.settingsViewContainer;
            if(container) {
                container.innerHTML = `
                    <h2 class="view-title">Inst√§llningar</h2>
                    <div class="setting-item">
                        <label for="agent-persona-input">Agentens Personlighet</label>
                        <p class="setting-description">Definiera hur du vill att FlowNode ska svara. T.ex. "en hj√§lpsam expert" eller "en kreativ id√©spruta".</p>
                        <input type="text" id="agent-persona-input" class="settings-input" value="${State.settings.agentPersona}">
                    </div>
                `;
                const input = container.querySelector('#agent-persona-input');
                if (input) {
                    input.onchange = (e) => {
                        State.settings.agentPersona = e.target.value;
                        State.save(); // Placeholder for saving
                    };
                }
            }
        }
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>










